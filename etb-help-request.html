<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber Plugin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff9800;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info {
            font-size: 13px;
            color: #666;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .info strong {
            color: #333;
        }
        
        .result {
            margin-top: 15px;
            padding: 12px;
            background-color: #e7f3ff;
            border-left: 4px solid #0066cc;
            border-radius: 4px;
            font-size: 13px;
            word-break: break-word;
        }
        
        .result strong {
            display: block;
            margin-bottom: 5px;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="status" class="status loading">
            <span class="loader"></span>
            Iniciando solicitud Uber...
        </div>
        
        <div id="info" class="info" style="display:none;">
            <strong>Activity ID:</strong> <span id="activityIdDisplay">-</span><br>
            <strong>Estado:</strong> <span id="stateDisplay">Procesando...</span>
        </div>
        
        <div id="result" class="result" style="display:none;">
            <strong>Respuesta API:</strong>
            <span id="resultMessage"></span>
        </div>
    </div>

    <script>
        // ============= CONFIGURACIÓN =============
        const CONFIG = {
            API_URL: 'https://devwebhook.ialeo.shop/webhook/etb-help-request',
            API_KEY: 'etb_2025_prd_9f8e7d6c5b4a3210fedcba0987654321',
            FIELD_NAME: 'resp_uberizacion', // Campo donde se guardará la respuesta
            TIMEOUT: 30000,
            AUTO_CLOSE_DELAY: 3000 // Cerrar automáticamente después de 3 segundos
        };

        // ============= ESTADO =============
        let pluginState = {
            activityId: null,
            activityData: null
        };

        // ============= ELEMENTOS DOM =============
        const elements = {
            status: document.getElementById('status'),
            info: document.getElementById('info'),
            result: document.getElementById('result'),
            activityIdDisplay: document.getElementById('activityIdDisplay'),
            stateDisplay: document.getElementById('stateDisplay'),
            resultMessage: document.getElementById('resultMessage')
        };

        // ============= COMUNICACIÓN CON OFSC =============
        
        function sendMessageToOFSC(message) {
            console.log('[OFSC] Enviando mensaje:', message);
            if (window.parent) {
                window.parent.postMessage(message, '*');
            }
        }

        function requestActivityData() {
            console.log('[PLUGIN] Solicitando datos de actividad...');
            sendMessageToOFSC({
                method: 'ready',
                sendInitData: true
            });
        }

        function updateOFSCField(fieldName, value) {
            console.log('[OFSC] Actualizando campo:', fieldName, '=', value);
            sendMessageToOFSC({
                method: 'updateActivity',
                activity: {
                    [fieldName]: value
                }
            });
        }

        function closePlugin() {
            console.log('[PLUGIN] Cerrando plugin...');
            sendMessageToOFSC({
                method: 'close'
            });
        }

        // ============= LISTENER DE MENSAJES OFSC =============
        
        window.addEventListener('message', function(event) {
            console.log('[OFSC] Mensaje recibido:', event.data);
            
            if (!event.data || !event.data.method) return;

            switch(event.data.method) {
                case 'initEnd':
                    handleInit(event.data);
                    break;
                case 'open':
                    handleInit(event.data);
                    break;
                case 'updateResult':
                    console.log('[OFSC] Campo actualizado exitosamente');
                    break;
            }
        });

        function handleInit(data) {
            console.log('[PLUGIN] Datos de inicialización recibidos:', data);
            
            if (data.activity) {
                pluginState.activityData = data.activity;
                
                // Obtener Activity ID
                pluginState.activityId = data.activity.aid || 
                                         data.activity.apptid || 
                                         data.activity.activityId;
                
                console.log('[PLUGIN] Activity ID:', pluginState.activityId);
                
                // Mostrar información
                elements.activityIdDisplay.textContent = pluginState.activityId || 'No disponible';
                elements.info.style.display = 'block';
                
                // Ejecutar llamada automáticamente
                if (pluginState.activityId) {
                    executeUberRequest();
                } else {
                    showError('No se pudo obtener el Activity ID');
                }
            } else {
                showError('No se recibieron datos de la actividad');
            }
        }

        // ============= LLAMADA A API EXTERNA =============
        
        async function executeUberRequest() {
            console.log('[API] Iniciando llamada a API externa...');
            
            updateStatus('loading', 'Llamando a API Uber...');
            elements.stateDisplay.textContent = 'Enviando solicitud...';
            
            try {
                const url = `${CONFIG.API_URL}?activityId=${pluginState.activityId}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
                
                console.log('[API] URL:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': CONFIG.API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        activityId: pluginState.activityId,
                        timestamp: new Date().toISOString(),
                        source: 'OFSC Mobile Plugin'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                console.log('[API] Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Error HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('[API] Response data:', result);
                
                // Extraer el mensaje de la respuesta
                const message = extractMessage(result);
                console.log('[API] Mensaje extraído:', message);
                
                // Actualizar campo en OFSC
                updateOFSCField(CONFIG.FIELD_NAME, message);
                
                // Mostrar éxito
                showSuccess(message);
                
                // Cerrar automáticamente
                setTimeout(() => {
                    closePlugin();
                }, CONFIG.AUTO_CLOSE_DELAY);
                
            } catch (error) {
                console.error('[API] Error:', error);
                
                let errorMessage = 'Error desconocido';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Tiempo de espera agotado';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                // Actualizar campo con error
                updateOFSCField(CONFIG.FIELD_NAME, `ERROR: ${errorMessage}`);
                
                showError(errorMessage);
            }
        }

        // ============= EXTRACCIÓN DE MENSAJE =============
        
        function extractMessage(apiResponse) {
            // Intentar extraer el mensaje de diferentes estructuras de respuesta
            if (typeof apiResponse === 'string') {
                return apiResponse;
            }
            
            if (apiResponse.message) {
                return apiResponse.message;
            }
            
            if (apiResponse.data && apiResponse.data.message) {
                return apiResponse.data.message;
            }
            
            if (apiResponse.result) {
                return apiResponse.result;
            }
            
            if (apiResponse.status) {
                return `Status: ${apiResponse.status}`;
            }
            
            // Si no encuentra un campo conocido, devolver JSON stringificado
            return JSON.stringify(apiResponse);
        }

        // ============= UI HELPERS =============
        
        function updateStatus(type, message) {
            elements.status.className = `status ${type}`;
            
            if (type === 'loading') {
                elements.status.innerHTML = `<span class="loader"></span>${message}`;
            } else {
                elements.status.innerHTML = message;
            }
        }

        function showSuccess(message) {
            updateStatus('success', '✓ Solicitud completada exitosamente');
            elements.stateDisplay.textContent = 'Completado';
            
            elements.resultMessage.textContent = message;
            elements.result.style.display = 'block';
            
            console.log('[PLUGIN] Éxito - Mensaje guardado en campo:', CONFIG.FIELD_NAME);
        }

        function showError(errorMessage) {
            updateStatus('error', `✗ Error: ${errorMessage}`);
            elements.stateDisplay.textContent = 'Error';
            
            elements.resultMessage.textContent = errorMessage;
            elements.result.style.display = 'block';
            elements.result.style.backgroundColor = '#fee';
            elements.result.style.borderLeftColor = '#c00';
            
            console.error('[PLUGIN] Error:', errorMessage);
            
            // No cerrar automáticamente en caso de error
        }

        // ============= INICIALIZACIÓN =============
        
        console.log('[PLUGIN] ===== UBER PLUGIN INICIADO =====');
        console.log('[PLUGIN] Versión: 1.0');
        console.log('[PLUGIN] Campo destino:', CONFIG.FIELD_NAME);
        
        // Solicitar datos de la actividad
        requestActivityData();
    </script>
</body>
</html>
