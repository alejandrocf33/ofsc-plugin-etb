<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uber Plugin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .status {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff9800;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info {
            font-size: 12px;
            color: #666;
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .info strong {
            color: #333;
        }
        
        .result {
            margin-top: 15px;
            padding: 12px;
            background-color: #e7f3ff;
            border-left: 4px solid #0066cc;
            border-radius: 4px;
            font-size: 13px;
            word-break: break-word;
        }
        
        .result strong {
            display: block;
            margin-bottom: 5px;
            color: #0066cc;
        }
        
        .debug-log {
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 11px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            color: #333;
        }
        
        .debug-log div {
            margin: 3px 0;
            padding: 2px;
            border-bottom: 1px solid #ddd;
        }
        
        .btn-retry {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-retry:active {
            background-color: #0052a3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="status" class="status loading">
            <span class="loader"></span>
            Iniciando solicitud Uber...
        </div>
        
        <div id="info" class="info">
            <strong>Activity ID:</strong> <span id="activityIdDisplay">Esperando...</span><br>
            <strong>Estado:</strong> <span id="stateDisplay">Conectando con OFSC...</span><br>
            <strong>Intentos:</strong> <span id="attemptsDisplay">0</span>
        </div>
        
        <div id="result" class="result" style="display:none;">
            <strong>Respuesta API:</strong>
            <span id="resultMessage"></span>
        </div>
        
        <button id="btnRetry" class="btn-retry" style="display:none;">
            Reintentar
        </button>
        
        <button id="btnClose" class="btn-retry" style="display:none; background-color: #28a745;">
            Cerrar y Regresar
        </button>
        
        <div id="debugLog" class="debug-log"></div>
    </div>

    <script>
        // ============= CONFIGURACIÓN =============
        const CONFIG = {
            API_URL: 'https://devwebhook.ialeo.shop/webhook/etb-help-request',
            API_KEY: 'etb_2025_prd_9f8e7d6c5b4a3210fedcba0987654321',
            FIELD_NAME: 'resp_uberizacion',
            TIMEOUT: 30000,
            AUTO_CLOSE_DELAY: 3000,
            MAX_INIT_ATTEMPTS: 5,
            RETRY_DELAY: 1000
        };

        // ============= ESTADO =============
        let pluginState = {
            activityId: null,
            activityData: null,
            attempts: 0,
            initialized: false
        };

        // ============= ELEMENTOS DOM =============
        const elements = {
            status: document.getElementById('status'),
            info: document.getElementById('info'),
            result: document.getElementById('result'),
            activityIdDisplay: document.getElementById('activityIdDisplay'),
            stateDisplay: document.getElementById('stateDisplay'),
            attemptsDisplay: document.getElementById('attemptsDisplay'),
            resultMessage: document.getElementById('resultMessage'),
            debugLog: document.getElementById('debugLog'),
            btnRetry: document.getElementById('btnRetry'),
            btnClose: document.getElementById('btnClose')
        };

        // ============= DEBUG LOG =============
        function addDebugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            elements.debugLog.appendChild(logEntry);
            elements.debugLog.scrollTop = elements.debugLog.scrollHeight;
            console.log(message);
        }

        // ============= COMUNICACIÓN CON OFSC =============
        
        function sendMessageToOFSC(message) {
            addDebugLog(`→ OFSC: ${JSON.stringify(message)}`);
            
            // Intentar diferentes targets
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(message, '*');
            }
            if (window.top && window.top !== window) {
                window.top.postMessage(message, '*');
            }
            if (window.opener) {
                window.opener.postMessage(message, '*');
            }
        }

        function requestActivityData() {
            pluginState.attempts++;
            elements.attemptsDisplay.textContent = pluginState.attempts;
            
            addDebugLog(`Intento ${pluginState.attempts} de ${CONFIG.MAX_INIT_ATTEMPTS}`);
            elements.stateDisplay.textContent = `Conectando (intento ${pluginState.attempts})...`;
            
            // Método 1: ready con sendInitData
            sendMessageToOFSC({
                method: 'ready',
                sendInitData: true
            });
            
            // Método 2: init
            setTimeout(() => {
                sendMessageToOFSC({
                    method: 'init'
                });
            }, 200);
            
            // Método 3: getActivityDetails
            setTimeout(() => {
                sendMessageToOFSC({
                    method: 'getActivityDetails'
                });
            }, 400);
            
            // Si no recibe respuesta, reintentar
            if (pluginState.attempts < CONFIG.MAX_INIT_ATTEMPTS && !pluginState.initialized) {
                setTimeout(() => {
                    if (!pluginState.initialized) {
                        requestActivityData();
                    }
                }, CONFIG.RETRY_DELAY);
            } else if (pluginState.attempts >= CONFIG.MAX_INIT_ATTEMPTS && !pluginState.initialized) {
                // Intentar obtener de query params como último recurso
                tryGetActivityFromURL();
            }
        }

        function tryGetActivityFromURL() {
            addDebugLog('Intentando obtener Activity ID de URL...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const activityId = urlParams.get('activityId') || 
                             urlParams.get('aid') || 
                             urlParams.get('apptid');
            
            if (activityId) {
                addDebugLog(`✓ Activity ID encontrado en URL: ${activityId}`);
                pluginState.activityId = activityId;
                pluginState.initialized = true;
                elements.activityIdDisplay.textContent = activityId;
                executeUberRequest();
            } else {
                addDebugLog('✗ No se encontró Activity ID en URL');
                showError('No se pudo conectar con OFSC. Verifica la configuración del plugin.');
                elements.btnRetry.style.display = 'block';
            }
        }

        // ============= LISTENER DE MENSAJES OFSC =============
        
        window.addEventListener('message', function(event) {
            addDebugLog(`← Mensaje: ${JSON.stringify(event.data).substring(0, 100)}`);
            
            if (!event.data) return;
            
            // Intentar extraer activity data de diferentes estructuras
            let activityData = null;
            
            if (event.data.activity) {
                activityData = event.data.activity;
            } else if (event.data.activityData) {
                activityData = event.data.activityData;
            } else if (event.data.data && event.data.data.activity) {
                activityData = event.data.data.activity;
            }
            
            if (activityData) {
                handleActivityData(activityData);
            }
            
            // Procesar métodos específicos
            if (event.data.method) {
                switch(event.data.method) {
                    case 'initEnd':
                    case 'open':
                        if (event.data.activity) {
                            handleActivityData(event.data.activity);
                        }
                        break;
                    case 'updateResult':
                        addDebugLog('✓ Campo actualizado en OFSC');
                        break;
                }
            }
        }, false);

        function handleActivityData(activity) {
            if (pluginState.initialized) return;
            
            addDebugLog('✓ Datos de actividad recibidos');
            pluginState.initialized = true;
            pluginState.activityData = activity;
            
            // Extraer Activity ID de múltiples posibles campos
            pluginState.activityId = activity.aid || 
                                     activity.apptid || 
                                     activity.activityId ||
                                     activity.id ||
                                     activity.AID ||
                                     activity.APPTID;
            
            if (pluginState.activityId) {
                addDebugLog(`✓ Activity ID: ${pluginState.activityId}`);
                elements.activityIdDisplay.textContent = pluginState.activityId;
                elements.stateDisplay.textContent = 'Conectado';
                executeUberRequest();
            } else {
                addDebugLog('✗ No se encontró Activity ID en los datos');
                showError('Activity ID no encontrado en los datos de OFSC');
                elements.btnRetry.style.display = 'block';
            }
        }

        function updateOFSCField(fieldName, value) {
            addDebugLog(`Actualizando campo ${fieldName} = ${value}`);
            
            // Formato correcto para OFSC Mobile
            const updateData = {};
            updateData[fieldName] = value;
            
            // Intentar método 1
            sendMessageToOFSC({
                method: 'updateActivity',
                activityData: updateData
            });
            
            // Intentar método 2
            setTimeout(() => {
                sendMessageToOFSC({
                    method: 'update',
                    activity: updateData
                });
            }, 100);
            
            // Intentar método 3
            setTimeout(() => {
                sendMessageToOFSC({
                    method: 'callProcedure',
                    procedure: 'activity.update',
                    params: updateData
                });
            }, 200);
        }

        function closePlugin() {
            addDebugLog('Cerrando plugin y regresando a actividad...');
            sendMessageToOFSC({
                method: 'close'
            });
            
            // Backup: intentar cerrar de otras formas
            setTimeout(() => {
                if (window.parent) {
                    sendMessageToOFSC({
                        method: 'back'
                    });
                }
            }, 100);
        }

        // ============= LLAMADA A API EXTERNA =============
        
        async function executeUberRequest() {
            addDebugLog('Iniciando llamada a API...');
            updateStatus('loading', 'Llamando a API Uber...');
            elements.stateDisplay.textContent = 'Enviando solicitud...';
            
            try {
                const url = `${CONFIG.API_URL}?activityId=${pluginState.activityId}`;
                addDebugLog(`URL: ${url}`);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': CONFIG.API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        activityId: pluginState.activityId,
                        timestamp: new Date().toISOString(),
                        source: 'OFSC Mobile Plugin'
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                addDebugLog(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addDebugLog(`Response: ${JSON.stringify(result).substring(0, 100)}`);
                
                const message = extractMessage(result);
                
                // Actualizar campo en OFSC
                updateOFSCField(CONFIG.FIELD_NAME, message);
                
                // Mostrar éxito
                showSuccess(message);
                
                // Mensaje para el usuario
                addDebugLog('Guardando en OFSC...');
                elements.stateDisplay.textContent = 'Guardando respuesta...';
                
                // Dar tiempo para que OFSC procese la actualización
                setTimeout(() => {
                    addDebugLog('Cerrando y regresando a actividad...');
                    closePlugin();
                }, 2000); // Reducido a 2 segundos pero con mejor feedback
                
            } catch (error) {
                addDebugLog(`✗ Error: ${error.message}`);
                
                let errorMessage = error.name === 'AbortError' 
                    ? 'Tiempo de espera agotado' 
                    : error.message;
                
                updateOFSCField(CONFIG.FIELD_NAME, `ERROR: ${errorMessage}`);
                showError(errorMessage);
                elements.btnRetry.style.display = 'block';
            }
        }

        function extractMessage(apiResponse) {
            if (typeof apiResponse === 'string') return apiResponse;
            if (apiResponse.message) return apiResponse.message;
            if (apiResponse.data && apiResponse.data.message) return apiResponse.data.message;
            if (apiResponse.result) return apiResponse.result;
            if (apiResponse.status) return `Status: ${apiResponse.status}`;
            return JSON.stringify(apiResponse);
        }

        // ============= UI HELPERS =============
        
        function updateStatus(type, message) {
            elements.status.className = `status ${type}`;
            if (type === 'loading') {
                elements.status.innerHTML = `<span class="loader"></span>${message}`;
            } else {
                elements.status.innerHTML = message;
            }
        }

        function showSuccess(message) {
            updateStatus('success', '✓ Solicitud completada');
            elements.stateDisplay.textContent = 'Completado';
            elements.resultMessage.textContent = message;
            elements.result.style.display = 'block';
            elements.btnClose.style.display = 'block'; // Mostrar botón de cerrar
            addDebugLog(`✓ Éxito: ${message}`);
        }

        function showError(errorMessage) {
            updateStatus('error', `✗ Error: ${errorMessage}`);
            elements.stateDisplay.textContent = 'Error';
            elements.resultMessage.textContent = errorMessage;
            elements.result.style.display = 'block';
            elements.result.style.backgroundColor = '#fee';
            elements.result.style.borderLeftColor = '#c00';
        }

        // ============= RETRY BUTTON =============
        
        elements.btnRetry.addEventListener('click', function() {
            pluginState.attempts = 0;
            pluginState.initialized = false;
            elements.btnRetry.style.display = 'none';
            elements.btnClose.style.display = 'none';
            elements.result.style.display = 'none';
            updateStatus('loading', 'Reintentando...');
            requestActivityData();
        });
        
        // ============= CLOSE BUTTON =============
        
        elements.btnClose.addEventListener('click', function() {
            addDebugLog('Usuario solicitó cerrar plugin');
            closePlugin();
        });

        // ============= INICIALIZACIÓN =============
        
        addDebugLog('===== UBER PLUGIN INICIADO =====');
        addDebugLog(`Versión: 2.0 (Mobile Enhanced)`);
        addDebugLog(`Campo destino: ${CONFIG.FIELD_NAME}`);
        addDebugLog(`User Agent: ${navigator.userAgent.substring(0, 50)}`);
        
        // Iniciar proceso de conexión
        requestActivityData();
    </script>
</body>
</html>
